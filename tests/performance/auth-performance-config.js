/**
 * EMR Authentication Performance Test Configuration
 *
 * Shared configuration, helper functions, and test data generators
 * for the EMR User Authentication performance test suite.
 *
 * This configuration supports healthcare-specific authentication patterns
 * and HIPAA-compliant audit logging requirements.
 */

import { check } from 'k6';
import { Rate, Counter, Trend } from 'k6/metrics';

// ============================================================================
// ENVIRONMENT CONFIGURATION
// ============================================================================

/**
 * Base configuration for all performance tests
 * Can be overridden via environment variables
 */
export const config = {
    // API endpoint configuration
    baseUrl: __ENV.BASE_URL || 'https://localhost:5001',
    apiVersion: 'v1',

    // Authentication configuration
    azureB2C: {
        authority: __ENV.AZURE_B2C_AUTHORITY || 'https://your-tenant.b2clogin.com/your-tenant.onmicrosoft.com',
        clientId: __ENV.AZURE_B2C_CLIENT_ID || 'your-client-id',
        signUpSignInPolicy: __ENV.AZURE_B2C_POLICY || 'B2C_1_signupsignin',
    },

    // Test data configuration
    testUsers: {
        patient: {
            count: parseInt(__ENV.PATIENT_COUNT || '50'),
            emailPrefix: 'patient.test',
            emailDomain: 'emr-perf.test'
        },
        doctor: {
            count: parseInt(__ENV.DOCTOR_COUNT || '10'),
            emailPrefix: 'doctor.test',
            emailDomain: 'emr-perf.test'
        },
        nurse: {
            count: parseInt(__ENV.NURSE_COUNT || '10'),
            emailPrefix: 'nurse.test',
            emailDomain: 'emr-perf.test'
        }
    },

    // Performance thresholds
    thresholds: {
        // Response time requirements
        p50: 200,  // 50th percentile < 200ms
        p95: 500,  // 95th percentile < 500ms
        p99: 1000, // 99th percentile < 1000ms

        // Error rate requirements
        errorRate: 0.01, // < 1% error rate

        // Success rate requirements
        successRate: 0.99, // > 99% success rate

        // Rate limiting expectations
        rateLimitThreshold: 0.05, // < 5% rate limit hits (expected under normal load)
    },

    // Load test parameters
    load: {
        // Virtual users (concurrent users)
        vus: {
            min: 10,
            target: parseInt(__ENV.TARGET_VUS || '100'),
            max: 200,
            stress: 500, // For stress testing
        },

        // Duration settings
        duration: {
            rampUp: '2m',      // Time to ramp up to target
            steadyState: '5m', // Time at target load
            rampDown: '1m',    // Time to ramp down
            soak: '30m',       // Extended duration for soak test
        },

        // Request pacing
        think_time: {
            min: 1,  // Minimum seconds between requests
            max: 5,  // Maximum seconds between requests
        }
    }
};

// ============================================================================
// CUSTOM METRICS
// ============================================================================

/**
 * Custom metrics for healthcare authentication monitoring
 */
export const metrics = {
    // Error tracking
    authErrors: new Rate('auth_errors'),
    validationErrors: new Rate('validation_errors'),
    serverErrors: new Rate('server_errors'),
    rateLimitErrors: new Rate('rate_limit_errors'),

    // Performance tracking
    loginDuration: new Trend('login_duration'),
    tokenRefreshDuration: new Trend('token_refresh_duration'),
    csrfTokenDuration: new Trend('csrf_token_duration'),
    apiCallDuration: new Trend('api_call_with_auth_duration'),

    // Success tracking
    successfulLogins: new Counter('successful_logins'),
    successfulTokenRefresh: new Counter('successful_token_refresh'),
    successfulApiCalls: new Counter('successful_api_calls'),

    // HIPAA audit tracking
    auditLogsGenerated: new Counter('audit_logs_generated'),

    // Cache performance
    cacheHits: new Counter('user_cache_hits'),
    cacheMisses: new Counter('user_cache_misses'),
};

// ============================================================================
// TEST DATA GENERATORS
// ============================================================================

/**
 * Generate a random user for testing
 *
 * ⚠️ HIPAA COMPLIANCE NOTICE ⚠️
 * All data generated by this function is SYNTHETIC TEST DATA.
 * This is NOT Protected Health Information (PHI).
 * Do NOT run these tests against production databases containing real patient data.
 *
 * @param {string} role - User role (Patient, Doctor, Nurse, Staff, Admin)
 * @param {number} index - User index for unique identification
 * @returns {Object} User object with test data
 */
export function generateTestUser(role = 'Patient', index = 0) {
    const rolePrefix = role.toLowerCase();
    const timestamp = Date.now();

    return {
        // Clear "TEST" prefix to prevent confusion with real PHI
        email: `TEST-${rolePrefix}.perf${index}.${timestamp}@emr-test-only.example`,
        firstName: `TEST_${role}`,
        lastName: `SYNTHETIC_User${index}`,
        azureAdB2CId: `TEST-azure-id-${role}-${index}-${timestamp}`,
        roles: [role],
        // Mock Azure B2C token (for simulation purposes)
        mockToken: generateMockJWT(role, index),
        // HIPAA compliance markers
        isTestData: true,
        testDataDisclaimer: 'SYNTHETIC TEST DATA - NOT REAL PHI - 45 CFR 164.514 COMPLIANT'
    };
}

/**
 * Generate a batch of test users
 * @param {string} role - User role
 * @param {number} count - Number of users to generate
 * @returns {Array} Array of user objects
 */
export function generateTestUsers(role = 'Patient', count = 10) {
    const users = [];
    for (let i = 0; i < count; i++) {
        users.push(generateTestUser(role, i));
    }
    return users;
}

/**
 * Generate a mock JWT token for testing
 * Note: In real tests, this should be replaced with actual Azure B2C tokens
 * @param {string} role - User role
 * @param {number} userId - User ID
 * @returns {string} Mock JWT token
 */
export function generateMockJWT(role, userId) {
    const header = btoa(JSON.stringify({ alg: 'RS256', typ: 'JWT' }));
    const payload = btoa(JSON.stringify({
        sub: `user-${role}-${userId}`,
        oid: `azure-${role}-${userId}`,
        roles: [role],
        exp: Math.floor(Date.now() / 1000) + 3600, // 1 hour expiry
        iat: Math.floor(Date.now() / 1000),
        iss: config.azureB2C.authority,
    }));
    const signature = btoa('mock-signature');

    return `${header}.${payload}.${signature}`;
}

/**
 * Generate patient search query
 * @returns {Object} Search parameters
 */
export function generatePatientSearchQuery() {
    const searchTerms = [
        'Smith',
        'Johnson',
        'Williams',
        'Brown',
        'Jones',
        'Garcia',
        'Miller',
        'Davis',
        'Rodriguez',
        'Martinez'
    ];

    const term = searchTerms[Math.floor(Math.random() * searchTerms.length)];
    const pageNumber = Math.floor(Math.random() * 5) + 1; // Pages 1-5
    const pageSize = [10, 20, 25, 50][Math.floor(Math.random() * 4)];

    return {
        searchTerm: term,
        pageNumber: pageNumber,
        pageSize: pageSize
    };
}

// ============================================================================
// VALIDATION HELPERS
// ============================================================================

/**
 * Check if response is successful (2xx status code)
 * @param {Response} response - HTTP response object
 * @returns {boolean} True if successful
 */
export function isSuccessful(response) {
    return response.status >= 200 && response.status < 300;
}

/**
 * Check if response is a rate limit error (429)
 * @param {Response} response - HTTP response object
 * @returns {boolean} True if rate limited
 */
export function isRateLimited(response) {
    return response.status === 429;
}

/**
 * Check if response is a validation error (400)
 * @param {Response} response - HTTP response object
 * @returns {boolean} True if validation error
 */
export function isValidationError(response) {
    return response.status === 400;
}

/**
 * Check if response is a server error (5xx)
 * @param {Response} response - HTTP response object
 * @returns {boolean} True if server error
 */
export function isServerError(response) {
    return response.status >= 500 && response.status < 600;
}

/**
 * Check if response is unauthorized (401)
 * @param {Response} response - HTTP response object
 * @returns {boolean} True if unauthorized
 */
export function isUnauthorized(response) {
    return response.status === 401;
}

/**
 * Validate authentication response
 * @param {Response} response - HTTP response object
 * @param {string} context - Test context for logging
 * @returns {boolean} True if validation passes
 */
export function validateAuthResponse(response, context = 'auth') {
    const checks = {
        [`${context}: status is 2xx`]: isSuccessful(response),
        [`${context}: response time < ${config.thresholds.p95}ms`]: response.timings.duration < config.thresholds.p95,
        [`${context}: has response body`]: response.body && response.body.length > 0,
    };

    const result = check(response, checks);

    // Track metrics
    if (isSuccessful(response)) {
        metrics.authErrors.add(0);
    } else if (isRateLimited(response)) {
        metrics.rateLimitErrors.add(1);
    } else if (isValidationError(response)) {
        metrics.validationErrors.add(1);
    } else if (isServerError(response)) {
        metrics.serverErrors.add(1);
    } else {
        metrics.authErrors.add(1);
    }

    return result;
}

/**
 * Validate API response with authentication
 * @param {Response} response - HTTP response object
 * @param {string} endpoint - API endpoint name
 * @returns {boolean} True if validation passes
 */
export function validateApiResponse(response, endpoint = 'api') {
    const checks = {
        [`${endpoint}: status is 2xx or 429`]: isSuccessful(response) || isRateLimited(response),
        [`${endpoint}: response time < ${config.thresholds.p99}ms`]: response.timings.duration < config.thresholds.p99,
        [`${endpoint}: has valid response`]: response.body && response.body.length > 0,
    };

    const result = check(response, checks);

    // Track metrics
    if (isSuccessful(response)) {
        metrics.successfulApiCalls.add(1);
        metrics.apiCallDuration.add(response.timings.duration);
    }

    return result;
}

// ============================================================================
// REQUEST HELPERS
// ============================================================================

/**
 * Get default headers for API requests
 * @param {string} csrfToken - CSRF token (optional)
 * @param {string} authToken - JWT token (optional)
 * @returns {Object} Headers object
 */
export function getDefaultHeaders(csrfToken = null, authToken = null) {
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
    };

    if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
    }

    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
    }

    return headers;
}

/**
 * Build full API URL
 * @param {string} endpoint - API endpoint path
 * @returns {string} Full URL
 */
export function buildUrl(endpoint) {
    // Remove leading slash if present
    const path = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
    return `${config.baseUrl}/api/${path}`;
}

// ============================================================================
// PERFORMANCE THRESHOLD CONFIGURATION
// ============================================================================

/**
 * Get k6 thresholds configuration
 * @returns {Object} Thresholds object for k6 options
 */
export function getThresholds() {
    return {
        // HTTP request duration thresholds
        'http_req_duration': [
            `p(50)<${config.thresholds.p50}`,
            `p(95)<${config.thresholds.p95}`,
            `p(99)<${config.thresholds.p99}`,
        ],

        // Error rate thresholds
        'http_req_failed': [
            `rate<${config.thresholds.errorRate}`,
        ],

        // Custom metric thresholds
        'auth_errors': [
            `rate<${config.thresholds.errorRate}`,
        ],
        'server_errors': [
            'rate<0.001', // < 0.1% server errors
        ],
        'rate_limit_errors': [
            `rate<${config.thresholds.rateLimitThreshold}`,
        ],

        // Performance metric thresholds
        'login_duration': [
            `p(95)<${config.thresholds.p95}`,
        ],
        'token_refresh_duration': [
            `p(95)<${config.thresholds.p95}`,
        ],
        'csrf_token_duration': [
            `p(95)<${config.thresholds.p95 / 2}`, // CSRF should be fast
        ],
        'api_call_with_auth_duration': [
            `p(95)<${config.thresholds.p95}`,
        ],
    };
}

// ============================================================================
// SCENARIO HELPERS
// ============================================================================

/**
 * Healthcare-specific authentication scenarios
 */
export const scenarios = {
    /**
     * Patient login scenario - highest volume
     */
    patientLogin: {
        executor: 'ramping-vus',
        startVUs: 0,
        stages: [
            { duration: '1m', target: 30 },
            { duration: '3m', target: 30 },
            { duration: '1m', target: 0 },
        ],
        gracefulRampDown: '30s',
        tags: { scenario: 'patient_login', role: 'Patient' },
    },

    /**
     * Healthcare provider login scenario - moderate volume
     */
    providerLogin: {
        executor: 'ramping-vus',
        startVUs: 0,
        stages: [
            { duration: '1m', target: 20 },
            { duration: '3m', target: 20 },
            { duration: '1m', target: 0 },
        ],
        gracefulRampDown: '30s',
        tags: { scenario: 'provider_login', role: 'Doctor' },
    },

    /**
     * Staff workflow scenario - continuous background load
     */
    staffWorkflow: {
        executor: 'constant-vus',
        vus: 10,
        duration: '5m',
        tags: { scenario: 'staff_workflow', role: 'Staff' },
    },
};

// ============================================================================
// THINK TIME HELPERS
// ============================================================================

/**
 * Simulate realistic user think time
 * Uses randomized sleep to simulate human behavior
 */
export function thinkTime() {
    const min = config.load.think_time.min;
    const max = config.load.think_time.max;
    const duration = Math.random() * (max - min) + min;

    return duration;
}

// ============================================================================
// REPORTING HELPERS
// ============================================================================

/**
 * Format test summary for console output
 * @param {Object} data - Test execution data
 * @returns {string} Formatted summary
 */
export function formatTestSummary(data) {
    return `
========================================
EMR Authentication Performance Test Summary
========================================

Test Configuration:
- Base URL: ${config.baseUrl}
- Target VUs: ${config.load.vus.target}
- Duration: ${config.load.duration.steadyState}

Performance Metrics:
- HTTP Req Duration (p95): ${data.metrics.http_req_duration?.['p(95)']?.toFixed(2)}ms
- HTTP Req Duration (p99): ${data.metrics.http_req_duration?.['p(99)']?.toFixed(2)}ms
- Error Rate: ${(data.metrics.http_req_failed?.rate * 100)?.toFixed(2)}%
- Successful Logins: ${data.metrics.successful_logins?.count || 0}
- Rate Limit Hits: ${(data.metrics.rate_limit_errors?.rate * 100)?.toFixed(2)}%

Thresholds:
- p95 Target: ${config.thresholds.p95}ms
- p99 Target: ${config.thresholds.p99}ms
- Max Error Rate: ${config.thresholds.errorRate * 100}%

========================================
`;
}

// ============================================================================
// EXPORTS
// ============================================================================

export default {
    config,
    metrics,
    generateTestUser,
    generateTestUsers,
    generateMockJWT,
    generatePatientSearchQuery,
    isSuccessful,
    isRateLimited,
    isValidationError,
    isServerError,
    isUnauthorized,
    validateAuthResponse,
    validateApiResponse,
    getDefaultHeaders,
    buildUrl,
    getThresholds,
    scenarios,
    thinkTime,
    formatTestSummary,
};
